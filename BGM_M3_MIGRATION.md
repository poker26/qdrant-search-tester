# Миграция на self-hosted BGM-M3 модель

## Обзор

Проект теперь поддерживает работу с self-hosted моделью BGM-M3 вместо OpenAI embeddings. Это позволяет:
- Работать без зависимости от внешних API
- Контролировать стоимость и производительность
- Использовать мультиязычную модель BGM-M3

## Настройка

### 1. Обновите `.env` файл

```bash
# Выберите модель эмбеддингов
EMBEDDING_MODEL=bgm-m3

# Настройки для BGM-M3
BGM_M3_URL=http://46.173.25.31
BGM_M3_PORT=8000
BGM_M3_ENDPOINT=/embed
BGM_M3_TIMEOUT=60.0

# Размерность вектора для BGM-M3 (1024)
COLLECTION_VECTOR_SIZE=1024
```

### 2. Проверьте доступность BGM-M3 API

```bash
curl -X POST http://46.173.25.31:8000/embed \
  -H "Content-Type: application/json" \
  -d '{"inputs": ["тестовый текст"]}'
```

Должен вернуться JSON с массивом векторов.

### 3. Пересоздайте коллекцию Qdrant

Если коллекция была создана с размерностью 1536 (OpenAI), нужно пересоздать её с размерностью 1024 (BGM-M3):

```bash
python qdrant_test_scripts/setup-qdrant.py --recreate
```

## Формат API BGM-M3

Поддерживаются следующие форматы запросов:

### Формат 1: `{"inputs": ["text1", "text2"]}`
```json
{
  "inputs": ["текст для эмбеддинга"]
}
```

### Формат 2: `{"texts": ["text1", "text2"]}`
```json
{
  "texts": ["текст для эмбеддинга"]
}
```

### Формат 3: OpenAI-compatible `{"input": "text"}`
```json
{
  "input": "текст для эмбеддинга"
}
```

## Формат ответа

Поддерживаются следующие форматы ответа:

- Прямой массив векторов: `[[0.1, 0.2, ...], [0.3, 0.4, ...]]`
- Объект с ключом `embeddings`: `{"embeddings": [[...]]}`
- Объект с ключом `data`: `{"data": [[...]]}`
- Объект с ключом `vectors`: `{"vectors": [[...]]}`

## Размерность векторов

- **OpenAI text-embedding-3-small**: 1536 измерений
- **BGM-M3**: 1024 измерения

⚠️ **Важно**: Коллекция Qdrant должна быть создана с правильной размерностью вектора!

## Возврат к OpenAI

Если нужно вернуться к OpenAI:

```bash
EMBEDDING_MODEL=openai
OPENAI_API_KEY=your-key-here
COLLECTION_VECTOR_SIZE=1536
```

И пересоздайте коллекцию с размерностью 1536.

## Устранение проблем

### Ошибка подключения к BGM-M3

1. Проверьте доступность сервера:
   ```bash
   ping 46.173.25.31
   ```

2. Проверьте порт:
   ```bash
   telnet 46.173.25.31 8000
   ```

3. Проверьте формат API - попробуйте разные форматы запроса

### Неправильная размерность вектора

Если получаете ошибку о несоответствии размерности:
1. Убедитесь, что `COLLECTION_VECTOR_SIZE` соответствует модели
2. Пересоздайте коллекцию с правильной размерностью

### Пустой ответ от API

Проверьте формат запроса и ответа. Клиент автоматически пробует разные форматы, но если API использует нестандартный формат, может потребоваться настройка.

## Тестирование

После настройки проверьте работу:

```bash
# Запустите тесты
python qdrant_test_scripts/test-runner-v2.py

# Или через дашборд
streamlit run streamlit_dashboard/test_dashboard.py
```

В дашборде должно отображаться: "✅ Используется модель: bgm-m3 (http://46.173.25.31:8000)"
